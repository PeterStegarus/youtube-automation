name: Upload
on:
  workflow_run:
    workflows: ["Scrape"]
    types:
      - completed
jobs:
  upload:
    name: Upload
    runs-on: ubuntu-latest
    env:
      CREDENTIALS: ${{ secrets.CREDENTIALS }}
      PUPPETEER_OPTIONS: '{ "headless": true }'
    steps:
      - uses: actions/checkout@main
      - uses: actions/setup-node@main
        with:
          node-version: 16
          cache: 'npm'
      - run: npm ci
      - name: Download videos
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: scrape.yml
          name: scraped-videos
          path: videos
      - name: Download videos.json
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: scrape.yml
          name: videos.json
          path: .
      - name: Download yt-auth from previous run 
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: upload.yml
          name: yt-auth
          path: yt-auth
      - name: Download backup yt-auth
        if: failure()
        run: curl https://data.atonline.net/\~jwt/eyJhY3QiOiJnZXQiLCJpbiI6eyJkbCI6dHJ1ZX0sIm1pbWUiOiJhcHBsaWNhdGlvbi94LXppcC1jb21wcmVzc2VkIiwicCI6ImJsb2JzcmMvYmxvYnMtZnR1cGkyLWF4dGYtZXczbC10eWVzLWQyamt0MmVlIn0/yt-auth.zip\?v\=1\&u\=phplatform\&e\=1661609327\&s\=_svkhP2Ujy34fv3gqeiI06gGzFVMlT2GI8q-jI7s0XE -o yt-auth.zip && unzip yt-auth.zip -d yt-auth
      - name: Run upload.js
        run: npm run upload
      - name: Upload videos.json
        uses: actions/upload-artifact@v3
        with:
          name: videos.json
          path: videos.json
      - name: Upload yt-auth
        uses: actions/upload-artifact@v3
        with:
          name: yt-auth
          path: yt-auth/*